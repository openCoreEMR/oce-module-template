FROM php:8.3-cli

# Install system dependencies
# hadolint ignore=DL3008
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    <<EOF
apt-get -qqy update
apt-get install -qqy --no-install-recommends \
    git \
    libicu-dev \
    libzip-dev \
    unzip
EOF

# Install PHP extensions
RUN docker-php-ext-install zip bcmath intl

# Install Xdebug for code coverage
RUN pecl install xdebug-3.3.2 \
 && docker-php-ext-enable xdebug

# Configure Xdebug for coverage only (not debugging)
COPY <<EOF /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
xdebug.mode=coverage
EOF

# Install Composer
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

# Set working directory
WORKDIR /app

# Copy composer files
COPY composer.json composer.lock ./

# Install dependencies (ignore platform requirements for development dependencies)
RUN --mount=type=cache,target=/root/.composer/cache \
    <<EOF
composer install \
    --no-interaction \
    --no-progress \
    --prefer-dist \
    --ignore-platform-reqs
EOF

# Copy application code
COPY . .

# Default command
CMD ["vendor/bin/phpunit", "--testdox"]
